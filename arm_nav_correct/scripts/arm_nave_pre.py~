#!/usr/bin/env python

"""
    drill_demo.py - Version 0.1 2015-11-05

    Use inverse kinemtatics to move the end effector to a set number of points to drill

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.5

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details at:

    http://www.gnu.org/licenses/gpl.html
"""

import rospy
import sys
import moveit_commander
from geometry_msgs.msg import PoseArray, PoseStamped

class DrillPrediction:
    def __init__(self):
        #Give the node a name
        rospy.init_node("drill_prediction", anonymous=False)
        
        rospy.loginfo("Starting node drill_prediction")
        
        rospy.on_shutdown(self.cleanup)

        # Initialize the move_group API
        moveit_commander.roscpp_initialize(sys.argv)

        # Initialize the move group for the ur5_arm
        self.arm = moveit_commander.MoveGroupCommander("ur5_arm")

        # Get the name of the end-effector link
        end_effector_link = self.arm.get_end_effector_link()

        # Set the reference frame for pose targets
        reference_frame = "/base_link"

        # Set the ur5_arm reference frame accordingly
        self.arm.set_pose_reference_frame(reference_frame)

        # Allow replanning to increase the odds of a solution
        self.arm.allow_replanning(True)

        # Allow some leeway in position (meters) and orientation (radians)
        self.arm.set_goal_position_tolerance(0.0001)
        self.arm.set_goal_orientation_tolerance(0.0001)

        # Start the arm in the work pose stored in the SRDF file
        self.arm.set_named_target("work")
        self.arm.go()
        rospy.sleep(2)

        hole_locations = rospy.wait_for_message("/initial_locations_drill", PoseArray)
        non_reachable_holes = PoseArray()
        location = 1

        # Set the target pose
        for hole_pose in hole_locations.poses:
            #Reset traj(s) to None
            traj = None
            traj_drill = None
            traj_remove = None
            

            #Move the end effecor to the x - .45, y, z positon
            #Set the target pose to the hole location in the base_link frame
            target_pose = PoseStamped()
            target_pose.header.frame_id = reference_frame
            target_pose.header.stamp = rospy.Time.now()
            target_pose.pose.position.x = hole_pose.position.x - 0.075
            target_pose.pose.position.y = hole_pose.position.y
            target_pose.pose.position.z = hole_pose.position.z
            target_pose.pose.orientation.x = hole_pose.orientation.x
            target_pose.pose.orientation.y = hole_pose.orientation.y
            target_pose.pose.orientation.z = hole_pose.orientation.z
            target_pose.pose.orientation.w = hole_pose.orientation.w

            # Set the start state to the current state
            self.arm.set_start_state_to_current_state()

            # Set the goal pose of the end effector to the stored pose
            self.arm.set_pose_target(target_pose, end_effector_link)

            # Plan the trajectory to the goal
            traj = self.arm.plan()

            if traj is not None:
                # Execute the planned trajectory
                self.arm.execute(traj)

                # Pause for a second
                rospy.sleep(1)
                
                rospy.loginfo("Successfully moved to hole " + str(location))
                
                rospy.sleep(1)
                
                rospy.loginfo("Successfully updated position of hole " + str(location))

                # Drill the part
                self.arm.shift_pose_target(0, 0.075, end_effector_link)

                # Plan the trajectory to the goal
                traj_drill = self.arm.plan()

                if traj_drill is not None:
                    # Execute the planned trajectory
                    self.arm.execute(traj_drill)
                    
                    # Pause for a second
                    rospy.sleep(1)

                    rospy.loginfo("Successfully drilled hole " + str(location))
                    location += 1
                    
                    self.arm.shift_pose_target(0, -0.075, end_effector_link)
                    
                    # Plan the trajectory to the goal
                    traj_remove = self.arm.plan()
                    
                    if traj_remove is not None:
                        # Execute the planned trajectory
                        self.arm.execute(traj_remove)
                        
                        # Pause for a second
                        rospy.sleep(1)
                        
                    else:
                        continue
            
                else:
                    rospy.loginfo("Unable to drill hole " + str(location))
                    non_reachable_holes.poses.append(target_pose)
                    location += 1
                    continue                   
                
            else:
                # Add hole to non_reachable_holes
                rospy.loginfo("Unable to reach hole " + str(location))
                non_reachable_holes.poses.append(target_pose)
                location += 1
                continue

        # Print  non_reachable_holes
        print non_reachable_holes

        # Finish the ur5_arm in the stow pose stored in the SRDF file
        self.arm.set_named_target("stow")
        self.arm.go()
        rospy.sleep(2)
        
    def cleanup(self):
        rospy.loginfo("Stopping the robot")
    
        # Stop any current arm movement
        self.arm.stop()
        
        # Move the arm to the stow position
        self.arm.set_named_target("stow")
        self.arm.go()
        
        #Shut down MoveIt! cleanly
        rospy.loginfo("Shutting down Moveit!")
        moveit_commander.roscpp_shutdown()
        moveit_commander.os._exit(0)


if __name__ == "__main__":
  try:
    DrillPrediction()
  except KeyboardInterrupt:
      print "Shutting down DrillPrediction node."
